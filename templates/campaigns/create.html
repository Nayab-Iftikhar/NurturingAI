{% extends 'base_app.html' %}
{% load static %}

{% block title %}Create Campaign - NurturingAI{% endblock %}

{% block extra_css %}
<style>
    .selected-leads {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
    }
    .lead-badge {
        display: inline-block;
        margin: 0.25rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        font-size: 0.9rem;
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .info-alert {
        background: #e7f3ff;
        border-left: 4px solid #667eea;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h2><i class="bi bi-megaphone"></i> Create Campaign</h2>
            <div class="d-flex gap-2">
                <a href="{% url 'campaigns_list' %}" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> View Campaigns
                </a>
                <a href="{% url 'conversations' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-envelope"></i> Conversations
                </a>
            </div>
        </div>
    </div>
    
    <div class="alert alert-info info-alert">
        <i class="bi bi-info-circle"></i> 
        <strong>Note:</strong> First filter and shortlist leads from the <a href="{% url 'leads' %}" class="alert-link">Leads page</a>, 
        then return here to create a campaign targeting those leads.
    </div>

    <form id="campaignForm">
        {% csrf_token %}
        
        <div class="card form-section">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Campaign Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Campaign Name (Optional)</label>
                        <input type="text" class="form-control" id="campaignName" 
                               placeholder="e.g., Summer 2025 Promotion">
                        <small class="text-muted">Leave blank to auto-generate from project name</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Campaign Project Name <span class="text-danger">*</span></label>
                        <select class="form-select" id="projectName" required>
                            <option value="">-- Select Project --</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nurturing Message Channel <span class="text-danger">*</span></label>
                        <select class="form-select" id="channel" required>
                            <option value="">-- Select Channel --</option>
                            <option value="email">Email</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Sales Offer Details</label>
                        <textarea class="form-control" id="offerDetails" rows="4" 
                                  placeholder="Enter special offers, discounts, or promotional details that will be included in all messages..."></textarea>
                        <small class="text-muted">This will be included in all generated messages just prior to the call to action</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card form-section">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Target Leads</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Selected Lead IDs <span class="text-danger">*</span></label>
                    <div class="selected-leads mb-3" id="selectedLeadsContainer">
                        <p class="text-muted mb-0">No leads selected. Please filter leads first.</p>
                    </div>
                    <input type="text" class="form-control" id="leadIds" 
                           placeholder="Enter lead IDs separated by commas (e.g., L1, L2, L3)" required>
                    <small class="text-muted">Enter lead IDs from your filtered results, or paste comma-separated lead IDs</small>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="loadFromStorage">
                    <i class="bi bi-arrow-clockwise"></i> Load from Last Filter Results
                </button>
            </div>
        </div>

        <div id="campaignStatus"></div>

        <div class="d-flex gap-2 mb-4">
            <button type="submit" class="btn btn-primary" id="createBtn">
                <i class="bi bi-plus-circle"></i> Create Campaign
            </button>
            <button type="button" class="btn btn-secondary" id="resetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
            <a href="{% url 'leads' %}" class="btn btn-outline-primary">
                <i class="bi bi-funnel"></i> Filter Leads First
            </a>
        </div>
    </form>
</div>

<script>
    // Get API headers
    function getApiHeaders() {
        const headers = {};
        const token = localStorage.getItem('authToken');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            headers['X-CSRFToken'] = csrfInput.value;
        }
        headers['Content-Type'] = 'application/json';
        return headers;
    }
    
    // Load project names
    async function loadProjects() {
        try {
            const headers = getApiHeaders();
            const response = await fetch('/api/leads/projects', {
                headers: headers,
                credentials: 'include'
            });
            if (response.ok) {
                const projects = await response.json();
                const select = document.getElementById('projectName');
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading projects:', error);
        }
    }
    
    // Update selected leads display
    function updateSelectedLeadsDisplay() {
        const leadIdsInput = document.getElementById('leadIds');
        const container = document.getElementById('selectedLeadsContainer');
        const leadIds = leadIdsInput.value.split(',').map(id => id.trim()).filter(id => id);
        
        if (leadIds.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No leads selected. Please filter leads first.</p>';
        } else {
            container.innerHTML = leadIds.map(id => 
                `<span class="lead-badge"><i class="bi bi-person"></i> ${id}</span>`
            ).join('');
        }
    }
    
    // Load from localStorage (from filter results)
    document.getElementById('loadFromStorage').addEventListener('click', () => {
        const storedLeads = localStorage.getItem('filteredLeadIds');
        if (storedLeads) {
            const leadIds = JSON.parse(storedLeads);
            document.getElementById('leadIds').value = leadIds.join(', ');
            updateSelectedLeadsDisplay();
        } else {
            alert('No filtered leads found in storage. Please filter leads first from the Leads page.');
        }
    });
    
    // Update display when lead IDs change
    document.getElementById('leadIds').addEventListener('input', updateSelectedLeadsDisplay);
    
    // Form submission
    document.getElementById('campaignForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const campaignName = document.getElementById('campaignName').value.trim();
        const projectName = document.getElementById('projectName').value;
        const channel = document.getElementById('channel').value;
        const offerDetails = document.getElementById('offerDetails').value.trim();
        const leadIdsInput = document.getElementById('leadIds').value;
        
        // Validate
        if (!projectName) {
            alert('Please select a project name');
            return;
        }
        if (!channel) {
            alert('Please select a message channel');
            return;
        }
        if (!leadIdsInput.trim()) {
            alert('Please enter at least one lead ID');
            return;
        }
        
        // Parse lead IDs
        const leadIds = leadIdsInput.split(',').map(id => id.trim()).filter(id => id);
        if (leadIds.length === 0) {
            alert('Please enter valid lead IDs');
            return;
        }
        
        // Build request data
        const campaignData = {
            name: campaignName || null,
            project_name: projectName,
            channel: channel,
            offer_details: offerDetails,
            lead_ids: leadIds
        };
        
        // Disable button
        const createBtn = document.getElementById('createBtn');
        createBtn.disabled = true;
        createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
        
        try {
            const headers = getApiHeaders();
            const response = await fetch('/api/campaigns/create', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(campaignData),
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                const campaignId = data.id;
                document.getElementById('campaignStatus').innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> Campaign Created Successfully!</h5>
                        <p><strong>Campaign ID:</strong> ${data.id} | <strong>Name:</strong> ${data.name}</p>
                        <p><strong>Project:</strong> ${data.project_name} | <strong>Channel:</strong> ${data.channel}</p>
                        <p><strong>Target Leads:</strong> ${data.leads_count}</p>
                        <div class="mt-3">
                            <button class="btn btn-success" id="generateMessagesBtn" data-campaign-id="${campaignId}">
                                <i class="bi bi-envelope"></i> Generate & Send Messages Now
                            </button>
                            <a href="/campaigns/list/" class="btn btn-outline-primary">
                                <i class="bi bi-list"></i> View All Campaigns
                            </a>
                        </div>
                    </div>
                `;
                
                // Add event listener for generate messages button
                document.getElementById('generateMessagesBtn').addEventListener('click', async () => {
                    await generateAndSendMessages(campaignId);
                });
                
                // Reset form
                document.getElementById('campaignForm').reset();
                document.getElementById('selectedLeadsContainer').innerHTML = 
                    '<p class="text-muted mb-0">No leads selected. Please filter leads first.</p>';
            } else {
                document.getElementById('campaignStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle"></i> 
                        ${data.error || 'Error creating campaign'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('campaignStatus').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle"></i> 
                    Error creating campaign: ${error.message}
                </div>
            `;
        } finally {
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Create Campaign';
        }
    });
    
    // Reset form
    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('campaignForm').reset();
        document.getElementById('selectedLeadsContainer').innerHTML = 
            '<p class="text-muted mb-0">No leads selected. Please filter leads first.</p>';
        document.getElementById('campaignStatus').innerHTML = '';
    });
    
    // Generate and send messages function
    async function generateAndSendMessages(campaignId) {
        const btn = document.getElementById('generateMessagesBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
        
        try {
            const headers = getApiHeaders();
            const response = await fetch(`/api/campaigns/${campaignId}/generate-messages`, {
                method: 'POST',
                headers: headers,
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('campaignStatus').innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> Messages Sent Successfully!</h5>
                        <p><strong>${data.sent}</strong> message(s) sent, <strong>${data.failed}</strong> failed.</p>
                        <p class="text-muted small">
                                    <i class="bi bi-info-circle"></i> All emails are sent to: <strong>nayabiftikhar6633@gmail.com</strong> (test mode)
                        </p>
                        ${data.errors && data.errors.length > 0 ? `
                            <div class="mt-2">
                                <strong>Errors:</strong>
                                <ul class="small">
                                    ${data.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="mt-3">
                            <a href="/campaigns/conversations/" class="btn btn-primary">
                                <i class="bi bi-envelope"></i> View Conversations
                            </a>
                            <a href="/campaigns/list/" class="btn btn-outline-primary">
                                <i class="bi bi-list"></i> View All Campaigns
                            </a>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('campaignStatus').innerHTML = `
                    <div class="alert alert-danger">
                        Error: ${data.error || data.message || 'Failed to send messages'}
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('campaignStatus').innerHTML = `
                <div class="alert alert-danger">
                    Error sending messages: ${error.message}
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Load projects on page load
    loadProjects();
    
    // Check if there are filtered leads in localStorage
    window.addEventListener('load', () => {
        const storedLeads = localStorage.getItem('filteredLeadIds');
        if (storedLeads) {
            const leadIds = JSON.parse(storedLeads);
            document.getElementById('leadIds').value = leadIds.join(', ');
            updateSelectedLeadsDisplay();
        }
    });
</script>
{% endblock %}
